!function(){"use strict";function e(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"_"+e()}String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.replaceAll=function(e,t){var n=new RegExp(e,"g");return this.replace(n,t)},angular.module("piemix.modules",["ngSanitize","ui.bootstrap"]).directive("pieMix",function(){return{restrict:"AEC",scope:{slices:"="},templateUrl:"template/piemix/template.html",controller:["$scope","$timeout","$element",function(t,n,r){var i=this;this.baseRadius=100,this.radiusIncrementFactor=.66,i.coordinates={},i._generateCoordinates=function(e,t,n){var r=e+"deg_"+t+"_rad"+n.toString();if("undefined"!=typeof i.coordinates[r]&&null!=i.coordinates[r])return i.coordinates[r];var a=0,o=0,l=Math.abs(t*Math.sin(.0174533*e)),c=Math.abs(t*Math.cos(.0174533*e));return e>=0&&90>=e?(a=n.x+l,o=n.y-c):e>=90&&180>=e?(a=n.x+l,o=n.y+c):e>=180&&270>=e?(a=n.x-l,o=n.y+c):(a=n.x-l,o=n.y-c),i.coordinates[r]={x:Math.ceil(a),y:Math.ceil(o)},i.coordinates[r]},i.generatedPies=[],i._generatePies=function(t,n,r){var a=_.reduce(t,function(e,t){return e+t.value},0),o=0;_.each(t,function(t,l){for(var c=0,d=i.baseRadius,u=i.baseRadius;n-1>c;)u*=i.radiusIncrementFactor,d+=u,c+=1;var s=360;"undefined"!=typeof r&&null!=r&&"undefined"!=typeof r.deg&&null!=r.deg&&(s=r.deg);var p=Math.ceil(t.value/a*s),h=o+p,f=o+p+("undefined"!=typeof t.degStart&&null!=t.degStart&&t.degStart!={}?t.degStart:0),g=o+(f-o)/2,x=i._generateCoordinates(o,d,i.centerXY),y=i._generateCoordinates(g,d,i.centerXY),m=i._generateCoordinates(f,d,i.centerXY),X=0;p>180&&(X=1),t._uid=e(),t.rad=d,t.deg=p,t.degStart=h-p,t.degEnd=h,t.startXY=x,t.midXY=y,t.endXY=m,t.pathCoeff=X,t.activecolor=t.color,t.priority=n;var Y="M"+t.startXY.x+" "+t.startXY.y+" A "+t.rad+" "+t.rad+", 0, "+t.pathCoeff+", 1, "+t.endXY.x+" "+t.endXY.y+" L "+i.centerXY.x+" "+i.centerXY.y+" Z";t.d=Y;var v=_.clone(t);delete v.child,i.generatedPies.push(v),"undefined"!=typeof t.child&&t.child!={}&&t.child.length>0&&i._generatePies(t.child,n+1,t),o=h})},i._calDeepLength=function(e){var t=0;return e.length>0&&(t+=1),_.each(e,function(e){"undefined"!=typeof e.child&&e.child!={}&&e.child.length>0&&(t+=i._calDeepLength(e.child))}),t},i._calMaxRadius=function(e){for(var t=i._calDeepLength(e),n=i.baseRadius,r=0;t-1>r;)n+=i.baseRadius*i.radiusIncrementFactor,r+=1;return n},i._getCenterXY=function(e,t){return i._maxRad=i._calMaxRadius(e),t="undefined"!==t&&t!={}&&null!=t?t:0,{x:i._maxRad+2*t,y:i._maxRad+2*t}},i._drawHelpBoxes=function(){var e=0,t=50,n=_.sortBy(angular.copy(i.generatedPies),function(e){return-e.priority});_.each(n,function(n){n.helpBoxX=i.centerXY.x+60+i._maxRad,n.helpBoxY=e+30,n.fillOpacity=1,e+=t;var r=_.find(i.generatedPies,function(e){return 0==e._uid.localeCompare(n._uid)});if("undefined"!=typeof r&&null!=r&&r!={}){r.helpBoxX=n.helpBoxX,r.textBoxX=n.helpBoxX+24,r.helpBoxY=n.helpBoxY,r.textBoxY=n.helpBoxY+12,r.fillOpacity=n.fillOpacity;var a={x:n.helpBoxX+70,y:n.helpBoxY-8},o={x:n.helpBoxX-70,y:n.helpBoxY-8},l=r.midXY,c=l.x+","+l.y+" "+o.x+","+o.y+" "+a.x+","+a.y;r.ptr=c}})},i._startGenerating=function(e){i.generatedPies=[],i.centerXY=i._getCenterXY(e,5),i.svgHolderWidth=i.svgWidth=2*i._maxRad+200,i.svgHolderHeight=i.svgHeight=2*i._maxRad,i._generatePies(e,1,null),n(i._drawHelpBoxes,500)},i.click=function(e){console.log(e)}}],controllerAs:"piemixctrl",bindToController:!0,replace:!0,link:function(e,t,n,r){e.$watch(function(e){return e.slices},function(e){r._startGenerating(r.slices)})}}})}();