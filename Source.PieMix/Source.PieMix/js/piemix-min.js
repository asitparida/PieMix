!function(){"use strict";function e(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"_"+e()}String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.replaceAll=function(e,t){var n=new RegExp(e,"g");return this.replace(n,t)},angular.module("piemix.modules",["ngSanitize","ui.bootstrap"]).directive("pieMix",["$parse",function(t){return{restrict:"AEC",scope:{slices:"=",config:"=",callbackOnClick:"&"},templateUrl:"template/piemix/template.html",controller:["$scope","$timeout","$element","$attrs","$parse",function(t,n,r,i,o){var a=this;a._generateCoordinates=function(e,t,n){var r=e+"deg_"+t+"_rad"+n.toString();if("undefined"!=typeof a.coordinates[r]&&null!=a.coordinates[r])return a.coordinates[r];var i=0,o=0,c=Math.abs(t*Math.sin(.0174533*e)),d=Math.abs(t*Math.cos(.0174533*e));return e>=0&&90>=e?(i=n.x+c,o=n.y-d):e>=90&&180>=e?(i=n.x+c,o=n.y+d):e>=180&&270>=e?(i=n.x-c,o=n.y+d):(i=n.x-c,o=n.y-d),a.coordinates[r]={x:Math.ceil(i),y:Math.ceil(o)},a.coordinates[r]},a._generatePies=function(t,n,r){var i=_.reduce(t,function(e,t){return e+t.value},0),o=0;_.each(t,function(t,c){for(var d=0,l=a.baseRadius,u=a.baseRadius;n-1>d;)u*=a.radiusIncrementFactor,l+=u,d+=1;var s=360;"undefined"!=typeof r&&null!=r&&"undefined"!=typeof r.deg&&null!=r.deg&&(s=r.deg);var f=Math.floor(t.value/i*s),g=o+f,y=o+f+("undefined"!=typeof t.degStart&&null!=t.degStart&&t.degStart!={}?t.degStart:0),x=o+(y-o)/2,h=a._generateCoordinates(o,l,a.centerXY),p=a._generateCoordinates(x,l,a.centerXY),m=a._generateCoordinates(x,l+15,a.centerXY),X=a._generateCoordinates(y,l,a.centerXY),Y=0;f>180&&(Y=1),t._uid=e(),t.rad=l,t.deg=f,t.degStart=g-f,t.effectiveDeg=y,t.midDeg=x,t.degEnd=g,t.startXY=h,t.midXY=p,t.offsetMidXY=m,t.endXY=X,t.pathCoeff=Y,t.activecolor=t.color,t.priority=n;var v="";v=360!=t.effectiveDeg?"M"+t.startXY.x+" "+t.startXY.y+" A "+t.rad+" "+t.rad+", 0, "+t.pathCoeff+", 1, "+t.endXY.x+" "+t.endXY.y+" L "+a.centerXY.x+" "+a.centerXY.y+" Z":"M "+a.centerXY.x+" "+a.centerXY.y+" m "+-t.rad+" 0 a "+t.rad+" "+t.rad+" 0 1 1 "+2*t.rad+" 0 a "+t.rad+" "+t.rad+" 0 1 1 "+-(2*t.rad)+" 0",t.d=v;var C=_.clone(t);delete C.child,a.generatedPies.push(C),"undefined"!=typeof t.child&&t.child!={}&&t.child.length>0&&a._generatePies(t.child,n+1,t),o=g})},a._calDeepLength=function(e){var t=0;return e.length>0&&(t+=1),_.each(e,function(e){"undefined"!=typeof e.child&&e.child!={}&&e.child.length>0&&(t+=a._calDeepLength(e.child))}),t},a._calMaxRadius=function(e){for(var t=a._calDeepLength(e),n=a.baseRadius,r=0;t-1>r;)n+=a.baseRadius*a.radiusIncrementFactor,r+=1;return n},a.getContainerWidth=function(){return"undefined"!=typeof r&&null!=r?r.width():2*a._maxRad},a.getContainerHeight=function(){return"undefined"!=typeof r&&null!=r?r.height():2*a._maxRad},a._getCenterXY=function(e,t){a._maxRad=a._calMaxRadius(e);var n=a.getContainerWidth()/2;return t="undefined"!==t&&t!={}&&null!=t?t:0,{x:n,y:a._maxRad+2*t}},a._calcQuadrants=function(){var e={},t=a.getContainerWidth(),n=(a.getContainerHeight(),a.centerXY),r=a.gapToLabel,i=a._maxRad;return t-30>=i+r?(e.NE=e.SE={x:n.x+i+r,y:10},e.NW=e.SW={x:n.x-i-r,y:10},e):void 0},a._getQuadrantKey=function(e){var t="";return e>=0&&90>=e?t="NE":e>90&&180>=e?t="SE":e>180&&270>=e?t="SW":e>270&&360>=e&&(t="NW"),t},a._drawHelpBoxes=function(){var e=55,t=_.map(angular.copy(a.generatedPies),function(e,t){return{midXY:e.midXY,midDeg:e.midDeg,offsetMidXY:e.offsetMidXY,priority:e.priority,rad:e.rad,id:e.id,title:e.title,side:e.midXY.x==a.centerXY.x?0:e.midXY.x>a.centerXY.x?1:-1}}),n=_.sortBy(_.filter(t,function(e){return 1==e.side}),function(e){return e.midDeg}),r=_.sortBy(_.filter(t,function(e){return 0==e.side||-1==e.side}),function(e){return-e.midDeg}),i=a._calcQuadrants(),o=null;console.log(n),_.each(n,function(t,n){console.log("***************************************************"),console.log(t);var r=a._getQuadrantKey(t.midDeg),c=_.clone(i[r]),d=t.offsetMidXY;if(null!=o&&d.y-o.y<e){var l=e-(d.y-o.y);console.log(d.y-o.y),console.log(l);var u={};"NE"==r?(d.y=d.y+l,console.log(1)):"SE"==r&&(u=a._generateCoordinates(t.midDeg,t.rad+30+l,a.centerXY),d=u,console.log(2))}var s={x:c.x,y:d.y},f={x:c.x+100,y:d.y},g=t.midXY;t._ptr=g.x+","+g.y+" "+d.x+","+d.y+" "+s.x+","+s.y+" "+f.x+","+f.y,t.colorBox={x:s.x,y:s.y+4},t.textBox={x:s.x+24,y:s.y+16},o=d,console.log("***************************************************")}),o=null,_.each(r,function(t,n){var r=a._getQuadrantKey(t.midDeg),c=_.clone(i[r]),d=t.offsetMidXY;if(null!=o&&d.y-o.y<e){var l=e-(d.y-o.y),u={};"NW"==r?d.y=d.y+l:"SW"==r&&(u=a._generateCoordinates(t.midDeg,t.rad+30+l,a.centerXY),d=u)}var s={x:c.x,y:d.y},f={x:c.x-100,y:d.y},g=t.midXY;t.colorBox={x:s.x-100,y:s.y+4},t.textBox={x:s.x-100+24,y:s.y+16},t._ptr=f.x+","+f.y+" "+s.x+","+s.y+" "+d.x+","+d.y+" "+g.x+","+g.y,o=d}),_.each(a.generatedPies,function(e){var t=e.midXY.x==a.centerXY.x?0:e.midXY.x>a.centerXY.x?1:-1;if(1==t){var i=_.find(n,function(t){return t.id==e.id});"undefined"!=typeof i&&(e.ptr=i._ptr,e.colorBox=i.colorBox,e.textBox=i.textBox,e.fillOpacity=1)}else if(-1==t){var i=_.find(r,function(t){return t.id==e.id});"undefined"!=typeof i&&(e.ptr=i._ptr,e.colorBox=i.colorBox,e.textBox=i.textBox,e.fillOpacity=1)}})},a._startGenerating=function(t){a.generatedPies=[],a.centerXY=a._getCenterXY(t,5),a.svgWidth=a.getContainerWidth(),a.svgHeight=a.getContainerHeight(),a._generatePies(t,1,null),1==a.showStrokeCircleAtCenter&&(a.strokeCircle={cx:a.centerXY.x,cy:a.centerXY.y,r:.5*a.baseRadius,fill:a.strokeColor});({_uid:e(),activecolor:a.strokeColor,color:a.strokeColor});n(a._drawHelpBoxes,500)},a._init=function(e){this.baseRadius=angular.copy(a.config.baseRadius)||100,this.radiusIncrementFactor=angular.copy(a.config.radiusIncrementFactor)||.66,this.gapToLabel=angular.copy(a.config.gapToLabel)||60,this.strokeColor=angular.copy(a.config.strokeColor)||"#fff",this.strokeWidth=angular.copy(a.config.strokeWidth)||0,this.showLabels=angular.copy(a.config.showLabels),this.showStrokeCircleAtCenter=angular.copy(a.config.showStrokeCircleAtCenter),a.coordinates={},a.generatedPies=[],a.centerXY={},a._maxRad={},a._startGenerating(e)},a.pieSliceClicked=function(e){a.callbackOnClick({data:e}),"function"==typeof a.config.pieSliceClicked&&a.config.pieSliceClicked({data:e})},a.config.highlightPie=function(e){_.each(a.generatedPies,function(t){t.id==e&&(t.activecolor="#000")})},a.config.dehighlightPie=function(e){_.each(a.generatedPies,function(t){t.id==e&&(t.activecolor=t.color)})}}],controllerAs:"piemixctrl",bindToController:!0,replace:!0,link:function(e,n,r,i){var o=[];angular.forEach(["slices","config"],function(n){if(r[n]){t(r[n]);o.push(e.$parent.$watch(angular.bind(i,function(){return this[n]}),function(e){i._init(angular.copy(i.slices))},!0))}})}}}])}();